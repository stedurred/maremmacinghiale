<?php// funzioniPayPal.phpfunction check_txnid($tnxid, $connection){// 	global $connection;	$valid_txnid = false;	//get result set	$sql = "SELECT * FROM pagamenti WHERE txn_id = '$tnxid'";	$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;	file_put_contents('logs/log_'.date("j.n.Y").'.txt',"--------check_txnid:".$log.PHP_EOL , FILE_APPEND);	try {		$res = mysqli_query($connection,$sql);				if ($row = mysqli_fetch_array($res)) {			$valid_txnid = true;			file_put_contents('logs/log_'.date("j.n.Y").'.txt',"--------check_txnid valid:".$valid_txnid.PHP_EOL , FILE_APPEND);		}	} catch (Exception $e) {		file_put_contents('logs/log_'.date("j.n.Y").'.txt',"--------check_txnid error:".$e.PHP_EOL , FILE_APPEND);			}		return $valid_txnid;}function check_price($price, $idPrenotazione, $connection){	$valid_price = false;		//file_put_contents('logs/log_'.date("j.n.Y").'.txt',"init check_price:$price & $idPrenotazione".PHP_EOL , FILE_APPEND);	//you could use the below to check whether the correct price has been paid for the product	//$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").mysqli_info($connection).PHP_EOL;    //$sql = "SELECT importo FROM evento WHERE id = 70";    $sql = "SELECT e.importo FROM evento e JOIN prenotazione p ON p.id_evento = e.id WHERE p.id = $idPrenotazione";    $log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;        file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);    //     try {        	$res = mysqli_query($connection,$sql) or trigger_error("Query Failed! SQL: $sql - Error: ".mysqli_error(), E_USER_ERROR);    //     } catch (Exception $e) {    //     	file_put_contents('logs/log_'.date("j.n.Y").'.txt',"--------sql error:".$e.PHP_EOL , FILE_APPEND);     //     }    //$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$res.PHP_EOL;        //file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);    $num_rows = mysqli_num_rows($res);    //$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."num_rows:".$num_rows.PHP_EOL;	 if ($num_rows != 0) {		$row = mysqli_fetch_assoc($res);		$num = floatval($row['importo']);		//$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."--------check_price num:".$num.PHP_EOL;		if($num == $price){			//$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."--------valid_price ".PHP_EOL;			$valid_price = true;					}	}	//file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);	return $valid_price;		}function check_payer($payer, $connection){	$valid_payer = false;	//file_put_contents('logs/log_'.date("j.n.Y").'.txt',"init check_price:$price & $idPrenotazione".PHP_EOL , FILE_APPEND);	//you could use the below to check whether the correct price has been paid for the product	//$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").mysqli_info($connection).PHP_EOL;	//$sql = "SELECT importo FROM evento WHERE id = 70";	$sql = "SELECT * FROM users WHERE email = '$payer' OR fb_user_email  = '$payer'";	$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;	file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);	//     try {	$res = mysqli_query($connection,$sql) or trigger_error("Query Failed! SQL: $sql - Error: ".mysqli_error(), E_USER_ERROR);	//     } catch (Exception $e) {	//     	file_put_contents('logs/log_'.date("j.n.Y").'.txt',"--------sql error:".$e.PHP_EOL , FILE_APPEND);	 	//     }	//$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$res.PHP_EOL;	//file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);	$num_rows = mysqli_num_rows($res);	//$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."num_rows:".$num_rows.PHP_EOL;	if ($num_rows != 0) {		$row = mysqli_fetch_assoc($res);				$valid_payer = true;		//$num = floatval($row['importo']);		//$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."--------check_price num:".$num.PHP_EOL;	}	//file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);	return $row;}function getPrenotazione($idPrenotazione,  $connection){	//$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").mysqli_info($connection).PHP_EOL;	$sql = "SELECT p.id FROM `prenotazione` p WHERE `id`= $idPrenotazione";	$res = mysqli_query($connection,$sql);	$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;	$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$res.PHP_EOL;	$num_rows = mysqli_num_rows($res);	$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."num_rows:".$num_rows.PHP_EOL;	file_put_contents('logs/log_'.date("j.n.Y").'.txt',"check_price:".$log.PHP_EOL , FILE_APPEND);	if ($num_rows != 0) {		$row = mysqli_fetch_assoc($res);		$idGetPrenotazione =$row['id'];		$log .= $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a")."--------idPrenotazione:".$idGetPrenotazione.PHP_EOL;	}	file_put_contents('logs/log_'.date("j.n.Y").'.txt',$log.PHP_EOL , FILE_APPEND);	return $idGetPrenotazione;}function updatePagamenti($data, $connection){// 	global $connection;	if (is_array($data)) {		$sql = "UPDATE pagamenti SET txn_id='".$data['txn_id']."' 									,importo_pagamento='".$data['payment_amount']."' 									,stato_pagamento='".$data['payment_status']."' 									,id_prenotazione='".$data['item_number']."' 									,data_pagamento='".date("Y-m-d H:i:s")."' 									WHERE txn_id='".$data['txn_id']."'";				$res = mysqli_query($connection,$sql);		$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;		file_put_contents('logs/log_'.date("j.n.Y").'.txt',"updatePagamenti:".$log.PHP_EOL , FILE_APPEND);		return mysqli_insert_id($connection);	}}function insertPagamenti($data, $connection){	// 	global $link;	if (is_array($data)) {		$sql = "INSERT INTO pagamenti (txn_id, importo_pagamento, stato_pagamento, id_prenotazione, data_pagamento) VALUES (				'".$data['txn_id']."' ,				'".$data['payment_amount']."' ,				'".$data['payment_status']."' ,				'".$data['item_number']."' ,				'".date("Y-m-d H:i:s")."'				)";				$res = mysqli_query($connection,$sql);		$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;		file_put_contents('logs/log_'.date("j.n.Y").'.txt',"insertPagamenti:".$log.PHP_EOL , FILE_APPEND);		return mysqli_insert_id($connection);	}}function updatePrenotazione($payer, $idPrenotazione, $connection){	$id_payer = $payer['id'];		$sql = "UPDATE prenotazione SET stato = 'Pagato' , id_user = $id_payer  WHERE id = $idPrenotazione";	$log = $_SERVER['SERVER_NAME'].' - '.date("F j, Y, g:i a").$sql.PHP_EOL;	file_put_contents('logs/log_'.date("j.n.Y").'.txt',"updatePrenotazione:".$log.PHP_EOL , FILE_APPEND);	mysqli_query($connection,$sql);	return mysqli_insert_id($connection);	}?>